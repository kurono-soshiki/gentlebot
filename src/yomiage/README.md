# 📢 Discord 読み上げbot（Yomiage Module）

Discord上でテキストメッセージを音声で読み上げる機能を提供するモジュールです。VOICEVOX エンジンを使用して、高品質な日本語音声合成を実現しています。

##  主な機能

- **自動読み上げ**: 指定したテキストチャンネルのメッセージを自動で音声化
- **音声カスタマイズ**: 音声を選択可能
- **スタイル変更**: 声色を選択可能
- **速度調整**: 0.1倍速〜3.0倍速まで調整
- **自動最適化**: URL省略、文字数制限、特殊文字除去などの自動処理
- **キュー管理**: 複数メッセージの順序制御と音声重複防止

##  使い方

### 1. 読み上げチャンネルの設定

#### 現在のテキストチャンネルを読み上げ対象に設定
```
/set_read_channel
```
- 実行したチャンネルが読み上げ対象として登録されます
- サーバーごとに1つのチャンネルのみ設定可能

#### 読み上げ設定を解除
```
/unset_read_channel
```
- 現在のチャンネルの読み上げ設定を削除します

### 2. ボイスチャンネルの参加・退出

#### ボットをVCに参加させる
```
/join
```
- 実行者が参加しているVCにボットが参加
- 同時に実行したチャンネルが読み上げ対象として設定される
- 既に他のVCに参加している場合は移動

#### ボットをVCから退出させる
```
/leave
```
- ボットがVCから退出します

> 💡 **自動退出機能**: 全てのユーザーがVCから退出すると、ボットも自動で退出し、読み上げチャンネルに通知を送信します

### 3. 音声設定のカスタマイズ

#### 読み上げ音声の変更
```
/set_voice <音声名>
```


#### 音声スタイルの変更
```
/set_voice_style <スタイル名>
```


#### 読み上げ速度の調整
```
/set_speed <速度>
```
- **範囲**: 0.1 〜 3.0
- **デフォルト**: 1.0（通常速度）
- **例**: `/set_speed 1.5` で1.5倍速に設定

### 4. 読み上げの実行

設定完了後、以下の条件が満たされると自動で読み上げが開始されます：

1. ボットがVCに参加している
2. 読み上げチャンネルが設定されている  
3. 設定されたチャンネルにメッセージが投稿される

## 🔧 自動処理機能

読み上げ時に以下の最適化が自動で行われます：

- **URL処理**: `https://example.com` → 「URL省略」
- **文字数制限**: 100文字超過時 → 「以下省略」を追加
- **特殊文字、改行処理**: 読み上げ対象ではない文字を除去
- **濁点・半濁点**: 音声の生成の不具合を回避するために「゛」「゜」を除去

##  システム仕様

### アーキテクチャ
```
Discord Message → Text Processing → VOICEVOX API → Audio Queue → Voice Output
```

### 主要コンポーネント
- **yomiage.py**: メインロジック、コマンド処理、キュー管理
- **voicebox.py**: VOICEVOX API連携、音声生成
- **voice.json**: 音声データ定義、スピーカー情報

### データ構造
```python
# サーバー設定
server_settings: {
    guild_id: {
        "read_channel": channel_id
    }
}

# ユーザー設定  
user_settings: {
    user_id: {
        "speaker_id": int,
        "speaker_name": str,
        "speed": float
    }
}
```

### 音声キュー管理
- **音声キュー**: `voice_queues[guild_id]` - 音声ファイルの待機列
- **処理キュー**: `processing_queues[guild_id]` - 重複処理防止フラグ
- **非同期処理**: 複数メッセージの順序制御

## 🛠️ 技術詳細

### 依存関係
- **discord.py**: Discord API連携
- **requests**: HTTP通信
- **asyncio**: 非同期処理
- **re**: 正規表現処理
- **collections.deque**: キュー管理

### VOICEVOX連携
- **エンドポイント**: `http://voicebox:50021`
- **API**: `/audio_query`, `/synthesis`, `/speakers`
- **音声形式**: WAV（FFmpeg経由でストリーミング）


